{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <p class="text-muted small mb-1">Assignment</p>
    <h1 class="h3 mb-1">{{ assignment.title }}</h1>
    {% if assignment.description %}
      <p class="text-muted mb-0">{{ assignment.description }}</p>
    {% endif %}
  </div>
  <div class="text-end">
    <p class="mb-1 small text-muted">Created {{ assignment.created_at.strftime('%d %b %Y %H:%M') }}</p>
    <div class="btn-group">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('lecturer.assignments') }}">
        <i class="bi bi-arrow-left"></i> Back to overview
      </a>
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('lecturer.assignment_edit', assignment_id=assignment.id) }}">
        <i class="bi bi-pencil"></i> Edit
      </a>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header">
    <h2 class="h5 mb-0">Documents</h2>
  </div>
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th scope="col">Label</th>
          <th scope="col">Filename</th>
          <th scope="col">Size</th>
          <th scope="col">Uploaded</th>
          <th scope="col" class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for document in assignment.documents %}
        <tr>
          <td>{{ document.label }}</td>
          <td>{{ document.filename }}</td>
          <td>{{ '%.1f'|format(document.file_size / 1024) }} KB</td>
          <td>{{ document.uploaded_at.strftime('%d %b %Y %H:%M') }}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('lecturer.download_document', document_id=document.id) }}">
              <i class="bi bi-cloud-download"></i> Download
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if primary_doc %}
<div class="card shadow-sm mt-4 summary-card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0">Document 1 summary</h2>
    {% if primary_doc.summary_updated_at %}
      <span class="badge text-bg-light">Updated {{ primary_doc.summary_updated_at.strftime('%d %b %Y %H:%M') }}</span>
    {% endif %}
  </div>
  <div class="card-body">
    {% if primary_doc.summary %}
      <p class="mb-3">{{ primary_doc.summary }}</p>
      {% if primary_doc.summary_model %}
        <p class="text-muted small mb-0">Model: {{ primary_doc.summary_model }}</p>
      {% endif %}
    {% else %}
      <p class="text-muted">No summary yet. Generate one when you are ready.</p>
    {% endif %}

    <form method="post" action="{{ url_for('lecturer.assignment_summary', assignment_id=assignment.id) }}" class="mt-3 d-flex flex-wrap gap-2 align-items-end">
      {{ summary_form.hidden_tag() }}
      {{ summary_form.assignment_id() }}
      <div>
        {{ summary_form.model.label(class="form-label") }}
        {{ summary_form.model(class="form-select form-select-sm") }}
      </div>
      <button type="submit" class="btn btn-primary btn-sm">{{ 'Regenerate summary' if primary_doc.summary else 'Generate summary' }}</button>
    </form>
  </div>
</div>
{% endif %}

<div class="card shadow-sm mt-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0">Conversation prompts</h2>
    <span class="badge text-bg-secondary">{{ assignment.prompts|length }}</span>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('lecturer.add_prompt', assignment_id=assignment.id) }}" novalidate class="mb-4">
      {{ prompt_form.hidden_tag() }}
      <div class="row g-3">
        <div class="col-md-4">
          {{ prompt_form.title.label(class="form-label") }}
          {{ prompt_form.title(class="form-control", placeholder="e.g. Reflection focus") }}
          {% for error in prompt_form.title.errors %}
            <div class="invalid-feedback d-block">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-8">
          {{ prompt_form.prompt_text.label(class="form-label") }}
          {{ prompt_form.prompt_text(class="form-control", placeholder="Guidance or questions to include in the AI context.") }}
          {% for error in prompt_form.prompt_text.errors %}
            <div class="invalid-feedback d-block">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-12">
          {{ prompt_form.example_response.label(class="form-label") }}
          {{ prompt_form.example_response(class="form-control", placeholder="Optional sample assistant reply") }}
          {% for error in prompt_form.example_response.errors %}
            <div class="invalid-feedback d-block">{{ error }}</div>
          {% endfor %}
        </div>
      </div>
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="submit" class="btn btn-primary">Add prompt</button>
      </div>
    </form>

    {% if assignment.prompts %}
      <div class="list-group list-group-flush">
        {% for prompt in assignment.prompts %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <h3 class="h6 mb-1">{{ prompt.title }}</h3>
              <p class="mb-1">{{ prompt.prompt_text }}</p>
              {% if prompt.example_response %}
                <p class="text-muted small mb-0">Example response: {{ prompt.example_response }}</p>
              {% endif %}
            </div>
            <form method="post" action="{{ url_for('lecturer.delete_prompt', prompt_id=prompt.id) }}" onsubmit="return confirm('Remove this prompt?');">
              {{ prompt_delete_form.csrf_token }}
              {{ prompt_delete_form.prompt_id(value=prompt.id) }}
              <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-0">No prompts yet. Add lecturer guidance to tailor the chat assistant.</p>
    {% endif %}
  </div>
</div>

<form method="post" action="{{ url_for('lecturer.assignment_delete', assignment_id=assignment.id) }}" class="mt-4" onsubmit="return confirm('Delete this assignment and all documents?');">
  {{ delete_form.hidden_tag() }}
  {{ delete_form.assignment_id() }}
  <button type="submit" class="btn btn-outline-danger">
    <i class="bi bi-trash"></i> Delete assignment
  </button>
</form>
{% endblock %}
