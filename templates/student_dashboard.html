{% extends "base.html" %}
{% block content %}
{% set progress = 25 if stage == 1 else (50 if stage == 2 else (75 if stage == 3 else 100)) %}
<div class="mb-4">
  <ol class="breadcrumb mb-3">
    <li class="breadcrumb-item {{ 'active' if stage >= 1 else '' }}">1. Choose assignment</li>
    <li class="breadcrumb-item {{ 'active' if stage >= 2 else '' }}">2. Upload analysis</li>
    <li class="breadcrumb-item {{ 'active' if stage >= 3 else '' }}">3. Review summaries</li>
    <li class="breadcrumb-item {{ 'active' if stage >= 4 else '' }}">4. Converse with AI</li>
  </ol>
  <div class="progress" style="height: 6px;">
    <div class="progress-bar" role="progressbar" style="width: {{ progress }}%" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
</div>

{% if stage == 1 %}
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Step 1 · Choose assignment</h2>
          <span class="badge text-bg-secondary">Required</span>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-3">Start by choosing which assignment you want to work on this session.</p>
          {% if assignments %}
          <form method="post" novalidate>
            {{ select_form.hidden_tag() }}
            <div class="mb-3">
              {{ select_form.assignment_id.label(class="form-label") }}
              {{ select_form.assignment_id(class="form-select") }}
              {% for error in select_form.assignment_id.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-primary">Continue to upload</button>
            </div>
          </form>
          {% else %}
          <div class="alert alert-info mb-0">No assignments are currently available. Check back later or contact your lecturer.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% elif stage == 2 %}
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Step 2 · Upload your case analysis</h2>
          <a href="{{ url_for('main.student', step=1) }}" class="btn btn-link btn-sm">&laquo; Back</a>
        </div>
        <div class="card-body">
          {% if active_assignment_title %}
            <p class="text-muted small mb-3">Active assignment: <strong>{{ active_assignment_title }}</strong></p>
            <form method="post" enctype="multipart/form-data" novalidate>
              {{ upload_form.hidden_tag() }}
              {{ upload_form.assignment_id() }}
              <div class="mb-3">
                {{ upload_form.document.label(class="form-label") }}
                {{ upload_form.document(class="form-control") }}
                {% for error in upload_form.document.errors %}
                  <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="mb-3">
                {{ upload_form.model.label(class="form-label") }}
                {{ upload_form.model(class="form-select") }}
                {% for error in upload_form.model.errors %}
                  <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('main.student', step=1) }}" class="btn btn-outline-secondary">Back</a>
                <button type="submit" class="btn btn-primary">Upload &amp; generate summary</button>
              </div>
            </form>
          {% else %}
            <div class="alert alert-warning mb-0">Select an assignment before uploading your case analysis.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% elif stage == 3 %}
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm student-summary-card" style="max-height:45vh; overflow:auto;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Lecturer summary</h2>
          <a href="{{ url_for('main.student', step=2) }}" class="btn btn-link btn-sm">&laquo; Back</a>
        </div>
        <div class="card-body">
          {% if assignment_summary_doc and assignment_summary_doc.summary %}
            <div class="markdown-output">{{ format_summary(assignment_summary_doc.summary) }}</div>
            {% if assignment_summary_doc.summary_model %}
              <p class="text-muted small mb-0">Model: {{ assignment_summary_doc.summary_model }} · Updated {{ assignment_summary_doc.summary_updated_at.strftime('%d %b %Y %H:%M') if assignment_summary_doc.summary_updated_at else 'n/a' }}</p>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">The lecturer has not published a summary for this assignment yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm student-summary-card" style="max-height:45vh; overflow:auto;">
        <div class="card-header">
          <h2 class="h6 mb-0">Your latest summary</h2>
        </div>
        <div class="card-body">
            {% if student_submissions %}
              {% set latest = student_submissions[0] %}
              <p><strong>{{ latest.filename }}</strong></p>
            {% if latest.summary %}
              <div class="markdown-output">{{ format_summary(latest.summary) }}</div>
                <p class="text-muted small mb-0">Model: {{ latest.summary_model or 'n/a' }} · Uploaded {{ latest.uploaded_at.strftime('%d %b %Y %H:%M') }}</p>
              {% else %}
                <p class="text-muted mb-0">Summary not available for this upload.</p>
              {% endif %}
            {% else %}
            <p class="text-muted mb-0">Upload your case analysis to generate a personal summary.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if student_submissions|length > 1 %}
  <div class="card shadow-sm mt-4" style="max-height:25vh; overflow:auto;">
    <div class="card-header">
      <h2 class="h6 mb-0">Submission history</h2>
    </div>
    <div class="list-group list-group-flush">
      {% for submission in student_submissions[1:] %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between flex-wrap gap-2">
          <div>
            <strong>{{ submission.filename }}</strong>
            <span class="text-muted small"> · {{ submission.uploaded_at.strftime('%d %b %Y %H:%M') }}</span>
          </div>
          <div class="text-muted small">{{ '%.1f'|format(submission.file_size / 1024) }} KB</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="d-flex justify-content-end mt-4">
    <a href="{{ url_for('main.student', step=4) }}" class="btn btn-primary">Continue to Step 4</a>
  </div>
{% else %}
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm student-summary-card" style="max-height:45vh; overflow:auto;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Lecturer summary</h2>
          <a href="{{ url_for('main.student', step=3) }}" class="btn btn-link btn-sm">&laquo; Back</a>
        </div>
        <div class="card-body">
          {% if assignment_summary_doc and assignment_summary_doc.summary %}
            <div class="markdown-output">{{ format_summary(assignment_summary_doc.summary) }}</div>
            {% if assignment_summary_doc.summary_model %}
              <p class="text-muted small mb-0">Model: {{ assignment_summary_doc.summary_model }} · Updated {{ assignment_summary_doc.summary_updated_at.strftime('%d %b %Y %H:%M') if assignment_summary_doc.summary_updated_at else 'n/a' }}</p>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">The lecturer has not published a summary for this assignment yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm student-summary-card" style="max-height:45vh; overflow:auto;">
        <div class="card-header">
          <h2 class="h6 mb-0">Your latest summary</h2>
        </div>
        <div class="card-body">
          {% if student_submissions %}
            {% set latest = student_submissions[0] %}
            <p><strong>{{ latest.filename }}</strong></p>
            {% if latest.summary %}
              <div class="markdown-output">{{ format_summary(latest.summary) }}</div>
              <p class="text-muted small mb-0">Model: {{ latest.summary_model or 'n/a' }} · Uploaded {{ latest.uploaded_at.strftime('%d %b %Y %H:%M') }}</p>
            {% else %}
              <p class="text-muted mb-0">Summary not available for this upload.</p>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">Upload your case analysis to generate a personal summary.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-lg-8">
      <div class="card shadow-sm" style="min-height:45vh;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Step 4 · Conversation</h2>
          <div class="d-flex align-items-center gap-2">
            <span class="badge text-bg-secondary">LLM assistant</span>
            {% if active_submission %}
            <form method="post" action="{{ url_for('main.restart_conversation') }}" class="d-inline">
              {{ chat_form.csrf_token }}
              <input type="hidden" name="chat-submission_id" value="{{ active_submission.id }}">
              <button type="submit" class="btn btn-outline-secondary btn-sm">Restart conversation</button>
            </form>
            <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.download_conversation', submission_id=active_submission.id) }}">
              <i class="bi bi-download"></i> Download PDF
            </a>
            {% endif %}
          </div>
        </div>
        <div class="card-body d-flex flex-column" style="min-height:45vh;">
          {% if active_prompt_message %}
            <p class="text-muted small mb-3">Respond to the prompt shown on the right to continue the lecturer sequence.</p>
          {% elif prompt_progress.total and prompt_progress.remaining == 0 %}
            <p class="text-muted small mb-3">All lecturer prompts are complete. Continue the discussion with DiaLoque or ask follow-up questions.</p>
          {% endif %}
          <div class="flex-grow-1 overflow-auto mb-3" style="max-height:40vh;">
            {% if conversation_messages %}
              <div class="list-group list-group-flush">
                {% for message in conversation_messages %}
                {% set ctx = message.get_context() or {} %}
                <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start gap-2">
                    <div class="flex-grow-1">
                      {% if message.role == 'lecturer' %}
                        <span class="badge text-bg-warning">Lecturer prompt</span>
                        {% if ctx.get('prompt_title') %}
                          <h3 class="h6 mt-2 mb-1">{{ ctx['prompt_title'] }}</h3>
                        {% endif %}
                        <div class="mt-2 mb-1 markdown-output">{{ message.content | replace('\n', '<br>') | safe }}</div>
                        {% if ctx.get('example_response') %}
                          <p class="text-muted small mb-0">Example response: {{ ctx['example_response'] }}</p>
                        {% endif %}
                      {% else %}
                        <span class="badge {{ 'text-bg-primary' if message.role == 'assistant' else 'text-bg-dark' }}">
                          {{ 'DiaLoque' if message.role == 'assistant' else 'You' }}
                        </span>
                        <div class="mt-2 mb-1 markdown-output">{{ message.content | replace('\n', '<br>') | safe }}</div>
                      {% endif %}
                    </div>
                    <div class="text-muted small text-end">
                      {{ message.created_at.strftime('%d %b %Y %H:%M') }}<br>
                      {% if message.role == 'assistant' and message.model %}Model: {{ message.model }}{% endif %}
                      {% if message.role == 'assistant' and ctx.get('total_tokens') %}<br>{{ ctx['total_tokens'] }} tokens{% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0">No conversation yet. Respond to the lecturer prompt to begin.</p>
            {% endif %}
          </div>
          <form method="post" action="{{ url_for('main.student', step=4) }}" novalidate class="mt-2">
            {{ chat_form.hidden_tag() }}
            {{ chat_form.submission_id() }}
          {% set message_placeholder = 'Share your response to the lecturer prompt...' if active_prompt_message else 'Ask a follow-up question or continue the discussion...' %}
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <div class="form-check">
                {{ chat_form.include_lecturer_summary(class="form-check-input", id="includeLecturerSummary") }}
                <label class="form-check-label" for="includeLecturerSummary">Lecturer summary</label>
              </div>
              <div class="form-check">
                {{ chat_form.include_student_summary(class="form-check-input", id="includeStudentSummary") }}
                <label class="form-check-label" for="includeStudentSummary">My summary</label>
              </div>
            </div>
            <div class="col-md-8">
              <label class="form-label" for="chat-message">Your response</label>
              {{ chat_form.message(class="form-control", id="chat-message", placeholder=message_placeholder) }}
              {% for error in chat_form.message.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="submit" class="btn btn-primary">Send</button>
          </div>
        </form>
      </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm student-prompts-card" style="max-height:45vh; overflow:auto;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Current lecturer prompt</h2>
          {% if prompt_progress.total %}
            <span class="badge text-bg-info">{{ prompt_progress.delivered }} / {{ prompt_progress.total }}</span>
          {% endif %}
        </div>
        <div class="card-body">
          {% if active_prompt_message %}
            {% set prompt_ctx = active_prompt_message.get_context() or {} %}
            {% if prompt_ctx.get('prompt_title') %}
              <h3 class="h6">{{ prompt_ctx['prompt_title'] }}</h3>
            {% endif %}
            <div class="markdown-output">{{ active_prompt_message.content | replace('\n', '<br>') | safe }}</div>
            {% if prompt_ctx.get('example_response') %}
              <p class="text-muted small mb-2">Example response: {{ prompt_ctx['example_response'] }}</p>
            {% endif %}
            {% if prompt_progress.total %}
              <p class="text-muted small mb-0">{{ prompt_progress.remaining }} prompt{{ 's' if prompt_progress.remaining != 1 else '' }} remaining.</p>
            {% endif %}
          {% elif prompt_progress.total == 0 %}
            <p class="text-muted mb-0">No lecturer prompts have been added for this assignment yet.</p>
          {% else %}
            <p class="text-muted mb-0">All lecturer prompts completed. Continue the conversation with DiaLoque.</p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
{% endif %}
{% endblock %}
